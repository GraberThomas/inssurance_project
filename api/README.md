# Insurance Prediction API

## Description

This backend API provides an intelligent system for predicting healthcare insurance costs. It leverages machine learning models to estimate costs and generate personalized insurance plan recommendations.

## Table of Contents

1. [Key Features](#key-features)
2. [Technical Architecture](#technical-architecture)
3. [API Reference](#api-reference)
4. [Models and Data](#models-and-data)
5. [Insurance Plan System](#insurance-plan-system)
6. [Recommendation System](#recommendation-system)
7. [Usage Examples](#usage-examples)

## Key Features

* **Cost Prediction**: Accurate estimation of insurance costs based on various factors
* **Dynamic Plans**: Automatic generation of tailored insurance plans
* **Personalized Recommendations**: Suggestions based on the user's health profile
* **SHAP Analysis**: Explanation of factors influencing predictions
* **RESTful API**: Full-featured REST interface with documentation

## Technical Architecture

### Prerequisites

* Python 3.x
* FastAPI
* pandas
* SHAP
* scikit-learn

### Project Structure

* `./models/`: Contains the trained ML models (generated by the "data\_model" project)
* Models are created and trained via the companion Python project "data\_model" included in this repository

## Installation and Deployment

### Standalone Installation

```bash
# Clone the repository
git clone https://github.com/your-repo/insurance-prediction-api.git
cd insurance-prediction-api

# Create a virtual environment
python -m venv venv
source venv/bin/activate  # On Linux/MacOS
# or
.\venv\Scripts\activate  # On Windows

# Install dependencies
pip install -r requirements.txt

# Launch the API
uvicorn main:app --reload
```

### Integration with the Ecosystem

This API is part of a suite of services and is designed to work in conjunction with:

* **frontend**: User interface for insurers
* **data\_model**: Service for ML model generation and training
* **backend\_persistence**: Persistence service for saving predictions

For full ecosystem deployment, refer to the main project documentation.

## API Reference

### Available Endpoints

* `GET /models` - Lists all available models
* `GET /models/{model_name}` - Details of a specific model
* `POST /models/{model_name}/predict` - Performs a prediction
* `GET /plans` - Lists available insurance plans

## Models and Data

### Input Format (InsuranceProfile)

```json
{
    "age": int,        // age (0-120)
    "sex": string,     // "male" or "female"
    "bmi": float,      // Body Mass Index (> 0)
    "children": int,   // Number of children (>= 0)
    "smoker": boolean, // Smoking status
    "region": string   // "northeast", "southeast", or "southwest"
}
```

### Output Format (PredictionResponse)

```json
{
    "prediction": float,           // Predicted cost
    "interval": [float, float],    // Confidence interval
    "mae": float,                  // Mean absolute error
    "risk_level": string,          // "lower", "moderate" or "high"
    "plan": {
        "name": string,            // Plan name
        "franchise": float,        // Deductible amount
        "ceiling": float|"Infinite", // Reimbursement ceiling
        "refund_estimate": float,  // Estimated reimbursement
        "annual_price": float,     // Annual price
        "monthly_price": float     // Monthly price
    },
    "top_factors": [
        {
            "feature": string,     // Factor name
            "shap_value": float,   // SHAP value
            "value": number|string // Factor value
        }
    ],
    "suggestions": [string]       // List of suggestions
}
```

## Insurance Plan System

### Plan Types

Three plan levels are offered with their characteristics:

* **Lower**:

  * Deductible rate: 30%
  * Ceiling rate: 100%
* **Moderate**:

  * Deductible rate: 25%
  * Ceiling rate: 90%
* **High**:

  * Deductible rate: 10%
  * Ceiling rate: 70%

## Recommendation System

### Processing Steps

1. **Prediction**: Base insurance cost estimation
2. **Risk Analysis**: Categorization into risk levels
3. **Dynamic Plan**: Automatic calculation of deductibles and ceilings
4. **Health Recommendations**: Personalized suggestions
5. **SHAP Analysis**: Identification of influential factors

## Usage Examples

### API Request

```bash
curl -X POST "http://localhost:8000/models/gradient_boosting/predict" \
     -H "Content-Type: application/json" \
     -d '{
         "age": 35,
         "sex": "male",
         "bmi": 24.5,
         "children": 2,
         "smoker": false,
         "region": "northeast"
     }'
```

### Sample Response

```json
{
    "prediction": 12350.75,
    "interval": [11850.25, 12850.25],
    "mae": 500.0,
    "risk_level": "moderate",
    "plan": {
        "name": "Moderate",
        "franchise": 3087.69,
        "ceiling": 11115.68,
        "refund_estimate": 8028.99,
        "annual_price": 8451.57,
        "monthly_price": 704.30
    },
    "top_factors": [
        {
            "feature": "bmi",
            "shap_value": 1250.5,
            "value": 24.5
        }
    ],
    "suggestions": [
        "Young client: consider offering the Eco Jeune plan."
    ]
}
```
